name: End-to-End Test

on:
  pull_request:
    paths:
      - 'bypass-service/**'
      - 'docker-compose.yml'
      - '.github/workflows/e2e-test.yml'
  workflow_dispatch:

jobs:
  test-bypass-service:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Start Services
        run: |
          docker compose up -d --build bypass-service
          
          echo "Waiting for service to be healthy..."
          sleep 10
          
          # Check logs
          docker compose logs bypass-service

      - name: Test Bypass Service (Default Mode)
        run: |
          curl -v -X POST http://localhost:5000/bypass \
            -H "Content-Type: application/json" \
            -d '{"url": "https://www.google.com", "mode": "default"}' \
            > response_default.json
            
          cat response_default.json
          
          if grep -q '"success":true' response_default.json; then
            echo "Default mode test passed"
          else
            echo "Default mode test failed"
            exit 1
          fi

      - name: Test Bypass Service (SeleniumBase Mode)
        # This is the critical test for x86_64 UC mode
        run: |
          # Use a site that often has challenges, or just a generic one to test browser startup
          # nowsecure.nl is often used for CF testing
          curl -v -X POST http://localhost:5000/bypass \
            -H "Content-Type: application/json" \
            -d '{"url": "https://nowsecure.nl", "mode": "seleniumbase", "timeout": 60}' \
            > response_sb.json
            
          cat response_sb.json
          
          if grep -q '"success":true' response_sb.json; then
            echo "SeleniumBase mode test passed"
          elif grep -q '"error"' response_sb.json; then
             # It might fail on captcha but should not fail on 'Exec format error'
             echo "SeleniumBase mode ran but might have failed validation (acceptable for basic integration test)"
          else
            echo "SeleniumBase mode test failed completely"
            exit 1
          fi

      - name: Dump Docker Logs on Failure
        if: failure()
        run: docker compose logs bypass-service
