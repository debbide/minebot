// ==UserScript==
// @name         Zampto Auto Renew (v3.6 Debug Mod)
// @namespace    http://tampermonkey.net/
// @version      3.6.1-Debug
// @description  åŸºäºv3.6ä¿®æ”¹ï¼š2åˆ†é’Ÿå¾ªç¯ + åˆ·æ–°é¢„çƒ­é€»è¾‘ï¼Œç”¨äºæ•…éšœæ’æŸ¥
// @author       Gemini
// @match        https://dash.zampto.net/server?id=2574*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // --- 1. å…¨å±€é…ç½® (è°ƒè¯•æ¨¡å¼) ---
    const CONFIG = {
        storageKey: 'zampto_v3_6_debug_mod',
        btnText: "Renew Server",
        renewInterval: 2 * 60 * 1000,  // ã€è°ƒè¯•ã€‘æ”¹ä¸º 2 åˆ†é’Ÿå¾ªç¯
        warmupDuration: 15 * 1000      // ã€è°ƒè¯•ã€‘åˆ·æ–°åç­‰å¾… 15 ç§’å†ç‚¹å‡»
    };

    // --- 2. çŠ¶æ€è¯»å– ---
    // çŠ¶æ€æµè½¬: idle (å€’è®¡æ—¶) -> warmup (åˆ·æ–°åç­‰å¾…) -> checking (ç‚¹å‡»åéªŒè¯) -> idle
    let data = JSON.parse(localStorage.getItem(CONFIG.storageKey)) || {
        nextRunTime: 0,
        status: 'idle', 
        logs: [],
        lastExpiryMinutes: 0,
        warmupEndTime: 0 // æ–°å¢ï¼šè®°å½•é¢„çƒ­ç»“æŸæ—¶é—´
    };

    // --- 3. æ ¸å¿ƒå·¥å…·å‡½æ•° ---

    // æ¨¡æ‹ŸçœŸå®é¼ æ ‡ç‚¹å‡»æµç¨‹
    function simulateClick(element) {
        if (!element) return;
        ['mouseover', 'mousedown', 'mouseup', 'click'].forEach(eventType => {
            const event = new MouseEvent(eventType, {
                bubbles: true,
                cancelable: true,
                view: window
            });
            element.dispatchEvent(event);
        });
    }

    // æå–å¹¶è®¡ç®—å‰©ä½™åˆ†é’Ÿæ•°
    function getCleanExpiryMinutes() {
        const elements = Array.from(document.querySelectorAll('p, div, span, li'));
        const target = elements.find(el => el.textContent.includes('Expiry') && !el.textContent.includes('function') && el.innerText.length < 150);
        if (!target) return 0;
        
        const text = target.innerText;
        let total = 0;
        text.replace(/(\d+)\s*day/g, (_, d) => total += d * 1440);
        text.replace(/(\d+)\s*h/g, (_, h) => total += h * 60);
        text.replace(/(\d+)\s*m/g, (_, m) => total += parseInt(m));
        return total;
    }

    // è·å–æ˜¾ç¤ºç”¨çš„æ—¶é—´æ–‡æœ¬
    function getExpiryDisplay() {
        const elements = Array.from(document.querySelectorAll('p, div, span, li'));
        const target = elements.find(el => el.textContent.includes('Expiry') && !el.textContent.includes('function'));
        return target ? target.innerText.replace('Expiry (Next Renewal):', '').trim() : "è·å–ä¸­...";
    }

    // --- 4. UI é¢æ¿æ„å»º (ä¿æŒ v3.6 åŸæ ·) ---
    const panel = document.createElement('div');
    panel.style = "position:fixed;bottom:10px;right:10px;width:420px;background:#0f0f0f;color:#ccc;z-index:999999;border:1px solid #444;padding:12px;font-family:'Consolas', monospace;font-size:12px;box-shadow: 0 0 20px rgba(0,0,0,0.9);border-radius:6px;";
    
    panel.innerHTML = `
        <div style="border-bottom:1px solid #444;margin-bottom:8px;padding-bottom:5px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:bold;color:#ff9800;font-size:14px;">ğŸ› ï¸ Zampto Debug (v3.6 Mod)</span>
            <button id="kb-hide" style="background:none;border:none;color:#666;cursor:pointer;font-size:14px;">[-]</button>
        </div>
        <div id="kb-content">
            <div id="kb-status" style="margin-bottom:10px;color:#fff;font-size:13px;background:#262626;padding:8px;border-radius:4px;border-left:4px solid #ff9800;">æ­£åœ¨è½½å…¥...</div>
            <div style="margin-bottom:10px;display:flex;gap:10px;">
                <button id="kb-reset" style="background:#d32f2f;color:white;border:none;padding:6px 15px;cursor:pointer;border-radius:4px;font-weight:bold;">é‡ç½®å¹¶è¿è¡Œ</button>
                <button id="kb-pause" style="background:#fbc02d;color:black;border:none;padding:6px 15px;cursor:pointer;border-radius:4px;font-weight:bold;">æš‚åœ</button>
            </div>
            <div id="kb-logs" style="height:400px;overflow-y:auto;border:1px solid #333;padding:8px;background:#000;border-radius:4px;line-height:1.4;"></div>
        </div>
    `;
    document.body.appendChild(panel);

    // æ—¥å¿—ç³»ç»Ÿ
    function log(msg, color = "#aaa") {
        const time = new Date().toLocaleTimeString();
        data.logs.unshift(`<div style="color:${color};margin-bottom:4px;border-bottom:1px dashed #222;padding-bottom:2px;"><span style="color:#555">[${time}]</span> ${msg}</div>`);
        if (data.logs.length > 80) data.logs.pop();
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        renderLogs();
    }
    
    function renderLogs() {
         const logDiv = document.getElementById('kb-logs');
         if(logDiv) logDiv.innerHTML = data.logs.join('');
    }

    function updateStatus(text, borderColor = "#a78bfa") { 
        const el = document.getElementById('kb-status');
        if(el) {
            el.innerHTML = text; 
            el.style.borderLeftColor = borderColor;
        }
    }

    // --- 5. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---

    // é€»è¾‘ A: å¯åŠ¨åˆ·æ–°æµç¨‹ (å€’è®¡æ—¶ç»“æŸåè§¦å‘)
    function startRefreshSequence() {
        log("â° å€’è®¡æ—¶ç»“æŸï¼Œæ‰§è¡Œåˆ·æ–°é¢„çƒ­...", "#ff9800");
        data.status = 'warmup';
        // è®¾å®šé¢„çƒ­ç»“æŸæ—¶é—´
        data.warmupEndTime = Date.now() + CONFIG.warmupDuration;
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        
        // æ‰§è¡Œåˆ·æ–°
        location.reload();
    }

    // é€»è¾‘ B: é¢„çƒ­ç­‰å¾… (åˆ·æ–°å½’æ¥åè§¦å‘)
    function processWarmup() {
        const now = Date.now();
        const diff = data.warmupEndTime - now;

        if (diff > 0) {
            const s = Math.floor(diff / 1000);
            updateStatus(`ğŸ”¥ é¡µé¢é¢„çƒ­ä¸­... ${s}ç§’ åç‚¹å‡»`, "#fbc02d");
            return;
        }

        // é¢„çƒ­ç»“æŸï¼Œæ‰§è¡Œç‚¹å‡»
        log("âœ… é¢„çƒ­å®Œæˆï¼Œå¼€å§‹å¯»æ‰¾æŒ‰é’®", "#4caf50");
        executeRenew();
    }

    // é€»è¾‘ C: æ‰§è¡Œç‚¹å‡»åŠ¨ä½œ
    async function executeRenew() {
        // 1. è®°å½•çŠ¶æ€
        const minutes = getCleanExpiryMinutes();
        data.lastExpiryMinutes = minutes; 
        data.status = 'checking'; // æ ‡è®°ä¸º"æ£€æŸ¥ä¸­"
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));

        log(`ğŸ–±ï¸ å‡†å¤‡ç‚¹å‡»... (å½“å‰: ${getExpiryDisplay()})`, "#2196f3");
        
        // 2. æ‰¾æŒ‰é’®
        const btn = Array.from(document.querySelectorAll('button, a')).find(el => el.textContent.includes(CONFIG.btnText));
        
        if (btn) {
            updateStatus("ğŸš€ æ­£åœ¨ç‚¹å‡»ï¼Œç­‰å¾…ç»“æœ...", "#2196f3");
            simulateClick(btn);
            log("ğŸš€ å·²è§¦å‘ç‚¹å‡»ï¼Œç­‰å¾…å“åº”...", "#ba68c8");
            
            // è°ƒè¯•æ¨¡å¼ä¸‹ï¼šå¦‚æœç½‘é¡µæ²¡è‡ªåŠ¨åˆ·æ–°ï¼Œ10ç§’åæˆ‘ä»¬å¼ºåˆ¶è‡ªæ£€
            await new Promise(r => setTimeout(r, 10000));
            log("ğŸ‘€ 10ç§’å·²è¿‡ï¼Œæ‰§è¡Œè‡ªæ£€...", "#90caf9");
            checkResult();
        } else {
            log("âŒ æœªæ‰¾åˆ°æŒ‰é’®ï¼Œ5ç§’åé‡è¯•", "#f44336");
            // ä¿æŒåœ¨ warmup çŠ¶æ€æˆ–é€€å› idle ç¨åé‡è¯•ï¼Œè¿™é‡Œé€‰æ‹©é€€å› idle å¿«é€Ÿé‡è¯•
            data.status = 'idle';
            data.nextRunTime = Date.now() + 5000; 
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        }
    }

    // é€»è¾‘ D: éªŒè¯ç»“æœ
    function checkResult() {
        const currentMinutes = getCleanExpiryMinutes();
        const displayTime = getExpiryDisplay();

        // è°ƒè¯•æ¨¡å¼ï¼šæ— è®ºæ˜¯å¦æˆåŠŸï¼Œéƒ½è®°å½•æ—¥å¿—ï¼Œå¹¶è¿›å…¥ä¸‹ä¸€ä¸ª 2åˆ†é’Ÿ å¾ªç¯
        if (currentMinutes > data.lastExpiryMinutes || currentMinutes > 2000) {
            log(`âœ… [è°ƒè¯•] ç»­æœŸæˆåŠŸ! æ–°æ—¶é—´: ${displayTime}`, "#4caf50");
        } else {
            log(`âš ï¸ [è°ƒè¯•] æ—¶é—´æœªå˜ (å½“å‰: ${displayTime})`, "#ff9800");
        }
        
        // è¿›å…¥ä¸‹ä¸€è½®
        log("â³ è¿›å…¥ä¸‹ä¸€è½® 2åˆ†é’Ÿ å€’è®¡æ—¶", "#fff");
        data.status = 'idle';
        data.nextRunTime = Date.now() + CONFIG.renewInterval;
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        updateStatus("âœ… ç­‰å¾…ä¸‹ä¸€è½®å¾ªç¯", "#4caf50");
    }

    // --- 6. ä¸»å¾ªç¯å¼•æ“ ---
    let isPaused = false;
    
    // æ¯ 1 ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
    setInterval(() => {
        if (isPaused) { updateStatus("ğŸ”´ è„šæœ¬å·²æš‚åœ", "#f44336"); return; }
        
        const now = Date.now();
        
        // çŠ¶æ€ 1: åˆšåˆ·æ–°å›æ¥ï¼Œå¤„äºé¢„çƒ­æœŸ
        if (data.status === 'warmup') {
            processWarmup();
            return;
        }

        // çŠ¶æ€ 2: åˆšç‚¹å®Œï¼Œå¤„äºéªŒè¯æœŸ
        if (data.status === 'checking') {
            updateStatus("ğŸ” æ­£åœ¨éªŒè¯ç»“æœ...", "#2196f3");
            checkResult();
            return;
        }

        // çŠ¶æ€ 3: å€’è®¡æ—¶ä¸­
        if (data.status === 'idle') {
            if (now < data.nextRunTime) {
                const diff = data.nextRunTime - now;
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                updateStatus(`â³ [è°ƒè¯•] ä¸‹æ¬¡ç»­æœŸ: ${m}åˆ† ${s}ç§’`);
            } else {
                // æ—¶é—´åˆ°äº†ï¼å…ˆå»åˆ·æ–°
                startRefreshSequence();
            }
        }

    }, 1000);

    // --- 7. äº‹ä»¶ç»‘å®š ---
    renderLogs();
    
    // é‡ç½®æŒ‰é’®
    document.getElementById('kb-reset').onclick = () => {
        if(confirm("é‡ç½®å°†æ¸…ç©ºæ—¥å¿—å¹¶é‡æ–°å¼€å§‹è°ƒè¯•ã€‚ç¡®å®šå—ï¼Ÿ")) {
            data = { nextRunTime: 0, status: 'idle', logs: [], lastExpiryMinutes: 0, warmupEndTime: 0 };
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
            location.reload();
        }
    };
    
    document.getElementById('kb-pause').onclick = function() {
        isPaused = !isPaused;
        this.innerText = isPaused ? "æ¢å¤" : "æš‚åœ";
    };
    
    document.getElementById('kb-hide').onclick = () => {
        const content = document.getElementById('kb-content');
        const btn = document.getElementById('kb-hide');
        const isHidden = content.style.display === 'none';
        content.style.display = isHidden ? 'block' : 'none';
        btn.innerText = isHidden ? "[-]" : "[+]";
    };

    log("ğŸ› ï¸ v3.6 è°ƒè¯•ç‰ˆå·²å°±ç»ª (2åˆ†å¾ªç¯+åˆ·æ–°é¢„çƒ­)", "#fff");

})();
