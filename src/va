// ==UserScript==
// @name         ValtoriaCloud Auto Renew (v3.1 Final Dutch Version)
// @namespace    http://tampermonkey.net/
// @version      3.1
// @description  å…¨åŠŸèƒ½ç‰ˆï¼š24hæ—¶é—´ç›‘æ§ + æ‹ŸäººåŒ–ç‚¹å‡» + çŠ¶æ€æœºæŒä¹…åŒ– + åå°é˜²ä¼‘çœ  (é€‚é… Vernieuw Nu)
// @author       Gemini
// @match        https://dash.valtoriacloud.xyz/server/manage?id=*
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// ==/UserScript==

(function() {
    'use strict';

    // --- 1. æ ¸å¿ƒé…ç½® ---
    const CONFIG = {
        storageKey: 'valtoria_v3_final',
        threshold: 24,           // å‰©ä½™æ—¶é—´å°äº 24 å°æ—¶è§¦å‘
        checkInterval: 5000,     // æ‰«æé¢‘ç‡ 5ç§’
        refreshCooldown: 300000, // 24hå†…è‹¥æ— æŒ‰é’®ï¼Œæ¯5åˆ†é’Ÿåˆ·æ–°é¡µé¢ä¸€æ¬¡
        btnRegex: /Vernieuw\s*Nu/i // é€‚é…å›¾ç‰‡ä¸­çš„ "Vernieuw Nu"
    };

    // --- 2. çŠ¶æ€æœºåˆå§‹åŒ– ---
    let data = JSON.parse(localStorage.getItem(CONFIG.storageKey)) || {
        isPaused: false,
        logs: [],
        lastRefresh: 0,
        status: 'idle', // idle, renewing
        retryCount: 0
    };

    // --- 3. UI ç•Œé¢æ„å»º ---
    GM_addStyle(`
        #vt-panel {
            position: fixed; bottom: 10px; right: 10px; width: 380px;
            background: #111; color: #ddd; z-index: 999999;
            border: 1px solid #333; border-radius: 10px; padding: 15px;
            font-family: 'Segoe UI', Consolas, monospace; font-size: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
        }
        #vt-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; }
        .vt-tag { background: #6f42c1; color: #fff; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; }
        .vt-status-box { background: #1e1e1e; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #6f42c1; }
        .vt-btn { cursor: pointer; border: none; padding: 6px 15px; border-radius: 4px; font-weight: bold; transition: 0.3s; }
        .btn-pause { background: #e67e22; color: #fff; }
        .btn-resume { background: #27ae60; color: #fff; }
        #vt-logs { height: 160px; overflow-y: auto; background: #000; border: 1px solid #222; padding: 8px; margin-top: 10px; border-radius: 4px; line-height: 1.5; }
        .log-time { color: #666; font-size: 10px; margin-right: 5px; }
        .log-info { color: #3498db; }
        .log-success { color: #2ecc71; font-weight: bold; }
        .log-warn { color: #f1c40f; }
        .log-error { color: #e74c3c; }
    `);

    const panel = document.createElement('div');
    panel.id = 'vt-panel';
    panel.innerHTML = `
        <div id="vt-header">
            <span><span class="vt-tag">V3.1 FINAL</span> è‡ªåŠ¨ç»­æœŸé¢æ¿</span>
            <span id="vt-running-indicator" style="color:#2ecc71;">â— RUNNING</span>
        </div>
        <div class="vt-status-box">
            <div>â° å‰©ä½™æ—¶é—´: <span id="vt-time-val" style="color:#f1c40f; font-weight:bold;">--</span></div>
            <div>ğŸ“¡ å¼•æ“çŠ¶æ€: <span id="vt-engine-status">æ£€æŸ¥ä¸­...</span></div>
        </div>
        <div style="display:flex; gap:10px;">
            <button id="vt-toggle" class="vt-btn ${data.isPaused ? 'btn-resume' : 'btn-pause'}">${data.isPaused ? 'æ¢å¤è¿è¡Œ' : 'æš‚åœè„šæœ¬'}</button>
            <button id="vt-reset" class="vt-btn" style="background:#444; color:#ccc;">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        <div id="vt-logs"></div>
    `;
    document.body.appendChild(panel);

    // --- 4. å·¥å…·å‡½æ•° ---
    function save() { localStorage.setItem(CONFIG.storageKey, JSON.stringify(data)); }

    function addLog(msg, type = 'info') {
        const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        data.logs.unshift({ time, msg, type });
        if (data.logs.length > 50) data.logs.pop();
        save();
        renderLogs();
    }

    function renderLogs() {
        const logContainer = document.getElementById('vt-logs');
        if (logContainer) {
            logContainer.innerHTML = data.logs.map(l =>
                `<div><span class="log-time">[${l.time}]</span><span class="log-${l.type}">${l.msg}</span></div>`
            ).join('');
        }
    }

    async function sleep(min, max) {
        const ms = Math.floor(Math.random() * (max - min + 1) + min);
        return new Promise(r => setTimeout(r, ms));
    }

    // --- 5. æ ¸å¿ƒé€»è¾‘å¼•æ“ ---
    function parseRemainingTime() {
        const text = document.body.innerText;
        // åŒ¹é…æ•°å­—+h æˆ– æ•°å­—+m
        const match = text.match(/(\d+)h\s+(\d+)m\s+remaining/i) || text.match(/(\d+)h\s+remaining/i);
        if (match) {
            return { 
                hours: parseInt(match[1]), 
                minutes: match[2] ? parseInt(match[2]) : 0 
            };
        }
        return null;
    }

    async function mainEngine() {
        if (data.isPaused || data.status === 'renewing') {
            document.getElementById('vt-running-indicator').innerText = data.isPaused ? "â—‹ PAUSED" : "âš™ï¸ PROCESSING";
            document.getElementById('vt-running-indicator').style.color = "#888";
            return;
        }

        const timeData = parseRemainingTime();
        const displayTime = document.getElementById('vt-time-val');
        const displayStatus = document.getElementById('vt-engine-status');

        // ç¬¬ä¸€æ­¥ï¼šæ¢æµ‹æŒ‰é’® (é€šè¿‡æ­£åˆ™åŒ¹é…æ–‡å­—)
        const btn = Array.from(document.querySelectorAll('button, a, .btn, .v-btn'))
                         .find(el => CONFIG.btnRegex.test(el.innerText) && el.offsetWidth > 0);

        if (btn) {
            data.status = 'renewing'; // é”å®šçŠ¶æ€ï¼Œé˜²æ­¢é‡å¤è§¦å‘
            displayStatus.innerText = "å‘ç° Vernieuw Nuï¼Œå‡†å¤‡ç‚¹å‡»";
            displayStatus.style.color = "#2ecc71";

            addLog("ğŸ¯ æ¢æµ‹åˆ°ç»­æœŸæŒ‰é’®ï¼Œæ‹ŸäººåŒ–ç­‰å¾…ä¸­...", "info");
            await sleep(3000, 6000); // éšæœºç­‰å¾…3-6ç§’

            addLog("ğŸš€ æ‰§è¡Œç»­æœŸæ“ä½œï¼", "success");
            btn.click();

            // ç‚¹å‡»åé”å®š UIï¼Œ5ç§’åå°è¯•åˆ·æ–°é¡µé¢ç¡®è®¤ç»“æœ
            setTimeout(() => { 
                data.status = 'idle';
                save();
                location.reload(); 
            }, 5000);
            return;
        }

        // ç¬¬äºŒæ­¥ï¼šè§£ææ—¶é—´æ˜¾ç¤º
        if (timeData) {
            displayTime.innerText = `${timeData.hours}h ${timeData.minutes}m`;

            if (timeData.hours < CONFIG.threshold) {
                displayStatus.innerText = "24h çª—å£å·²å¼€å¯ï¼Œç›‘æ§æŒ‰é’®å‡ºç°...";
                displayStatus.style.color = "#f1c40f";

                const now = Date.now();
                if (now - data.lastRefresh > CONFIG.refreshCooldown) {
                    addLog("â³ åˆ°è¾¾ç»­æœŸçª—å£ä½†æŒ‰é’®æœªåŠ è½½ï¼Œåˆ·æ–°é¡µé¢...", "warn");
                    data.lastRefresh = now;
                    save();
                    location.reload();
                }
            } else {
                displayStatus.innerText = "æ—¶é—´å……è£•ï¼Œé™é»˜ç›‘æ§ä¸­";
                displayStatus.style.color = "#888";
            }
        } else {
            displayTime.innerText = "æœªæ£€æµ‹åˆ°æ—¶é—´æ–‡æœ¬";
            displayStatus.innerText = "æ­£åœ¨æ‰«æé¡µé¢ç»“æ„...";
        }
    }

    // --- 6. äº‹ä»¶ç»‘å®š ---
    document.getElementById('vt-toggle').addEventListener('click', function() {
        data.isPaused = !data.isPaused;
        this.innerText = data.isPaused ? 'æ¢å¤è¿è¡Œ' : 'æš‚åœè„šæœ¬';
        this.className = `vt-btn ${data.isPaused ? 'btn-resume' : 'btn-pause'}`;
        addLog(data.isPaused ? "â¸ è„šæœ¬æ‰‹åŠ¨æš‚åœ" : "â–¶ï¸ è„šæœ¬æ¢å¤å·¥ä½œ", "info");
        save();
    });

    document.getElementById('vt-reset').addEventListener('click', () => {
        data.logs = [];
        save();
        renderLogs();
    });

    // --- 7. é˜²ä¼‘çœ è¡¥ä¸ ---
    setInterval(() => {
        if (!data.isPaused) {
            const dot = document.createElement('div');
            dot.style.cssText = "width:1px;height:1px;position:fixed;bottom:0;right:0;opacity:0.01;pointer-events:none;";
            document.body.appendChild(dot);
            setTimeout(() => dot.remove(), 1000);
        }
    }, 30000);

    // --- 8. å¯åŠ¨ ---
    renderLogs();
    addLog("âœ… Valtoria v3.1 (Dutch) åŠ è½½æˆåŠŸ", "info");
    setInterval(mainEngine, CONFIG.checkInterval);

})();
